#services:
#  # ==================== BOOKING SERVICE ====================
#
#  # MongoDB Database for Booking Service
#  booking-mongodb:
#    image: mongo:7.0
#    container_name: booking-service-mongodb
#    environment:
#      MONGO_INITDB_DATABASE: booking-service
#    ports:
#      - "27018:27017"
#    volumes:
#      - booking_mongodb_data:/data/db
#      - booking_mongodb_config:/data/configdb
#    networks:
#      - shared-microservices-network
#    healthcheck:
#      test: ["CMD-SHELL", "mongosh --eval 'db.runCommand(\"ping\").ok' --quiet"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 60s
#    restart: unless-stopped
#
#  # Booking Service SonarQube PostgreSQL
#  booking-sonarqube-postgres:
#    image: postgres:15-alpine
#    container_name: booking-sonarqube-postgres
#    environment:
#      POSTGRES_DB: booking_sonarqube
#      POSTGRES_USER: sonar
#      POSTGRES_PASSWORD: sonar123
#    ports:
#      - "5435:5432"
#    volumes:
#      - booking_sonarqube_postgres_data:/var/lib/postgresql/data
#    networks:
#      - shared-microservices-network
#    healthcheck:
#      test: ["CMD-SHELL", "pg_isready -U sonar -d booking_sonarqube"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 60s
#    restart: unless-stopped
#
#  # Booking Service SonarQube Server
#  booking-sonarqube:
#    image: sonarqube:10.7.0-community
#    container_name: booking-sonarqube-server
#    environment:
#      SONAR_JDBC_URL: jdbc:postgresql://booking-sonarqube-postgres:5432/booking_sonarqube
#      SONAR_JDBC_USERNAME: sonar
#      SONAR_JDBC_PASSWORD: sonar123
#      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: true
#      SONAR_WEB_JAVAADDITIONALOPTS: "-Xmx512m -Xms128m"
#      SONAR_CE_JAVAADDITIONALOPTS: "-Xmx512m -Xms128m"
#    ports:
#      - "9003:9000"
#    volumes:
#      - booking_sonarqube_data:/opt/sonarqube/data
#      - booking_sonarqube_extensions:/opt/sonarqube/extensions
#      - booking_sonarqube_logs:/opt/sonarqube/logs
#    depends_on:
#      booking-sonarqube-postgres:
#        condition: service_healthy
#    networks:
#      - shared-microservices-network
#    healthcheck:
#      test: ["CMD-SHELL", "curl -f http://localhost:9000/api/system/status || exit 1"]
#      interval: 60s
#      timeout: 30s
#      retries: 5
#      start_period: 180s
#    restart: unless-stopped
#    ulimits:
#      nofile:
#        soft: 65536
#        hard: 65536
#
#  # Booking Service Application
#  booking-service:
#    build:
#      context: .
#      dockerfile: Dockerfile
#    image: godfrey10/booking-service:latest
#    container_name: booking-service-app
#    environment:
#      # Spring Profile
#      SPRING_PROFILES_ACTIVE: default
#
#      # ============ DISABLE RABBITMQ ============
#      # This prevents Spring Boot from trying to auto-configure RabbitMQ
#      SPRING_AUTOCONFIGURE_EXCLUDE: org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration
#
#      # MongoDB Configuration
#      SPRING_DATA_MONGODB_URI: mongodb://booking-mongodb:27017/booking-service
#      SPRING_DATA_MONGODB_AUTO_INDEX_CREATION: true
#
#      # Application Configuration
#      SPRING_APPLICATION_NAME: Booking-Service
#      SERVER_PORT: 8084
#      SPRING_MAIN_ALLOW_BEAN_DEFINITION_OVERRIDING: true
#
#      # Keycloak OAuth2 Configuration
#      # Use localhost:8090 for token validation from host
#      # Use keycloak:8080 for internal Docker network communication
#      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://localhost:8090/realms/friendly-housing
#      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:8080/realms/friendly-housing/protocol/openid-connect/certs
#
#      # Keycloak Admin Client Configuration
#      # Use keycloak:8080 for internal Docker communication
#      KEYCLOAK_AUTH_SERVER_URL: http://keycloak:8080
#      KEYCLOAK_REALM: friendly-housing
#      KEYCLOAK_RESOURCE: booking-service
#      KEYCLOAK_CREDENTIALS_SECRET: Lrf6ZwUcAqOnvg4fl89kKyiOLCaWDb6B
#
#      # Microservices URLs - Inter-service communication
#      # Use container names for Docker network communication
#      MICROSERVICES_APPOINTMENT_SERVICE_URL: http://appointment-service-app:8083
#      MICROSERVICES_PROPERTY_SERVICE_URL: http://property-service-app:8082
#      MICROSERVICES_USER_SERVICE_URL: http://user-service-app:8081
#
#      # Actuator/Monitoring Configuration
#      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,metrics,prometheus,info
#      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
#      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: true
#      MANAGEMENT_ENDPOINTS_ENABLED_BY_DEFAULT: true
#
#      # Swagger/OpenAPI Configuration
#      SPRINGDOC_API_DOCS_PATH: /api-docs
#      SPRINGDOC_SWAGGER_UI_PATH: /swagger-ui.html
#      SPRINGDOC_SWAGGER_UI_ENABLED: true
#
#      # Logging Configuration
#      LOGGING_LEVEL_ROOT: INFO
#      LOGGING_LEVEL_COM_EXAMPLE_BOOKINGSERVICE: DEBUG
#      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_DATA_MONGODB_CORE_MONGOTEMPLATE: DEBUG
#      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_DATA_MONGODB: DEBUG
#      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: DEBUG
#      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY: DEBUG
#      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY_OAUTH2: DEBUG
#      LOGGING_LEVEL_FEIGN: DEBUG
#      LOGGING_PATTERN_CONSOLE: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
#
#      # Spring Cloud Configuration
#      SPRING_CLOUD_COMPATIBILITY_VERIFIER_ENABLED: false
#
#    ports:
#      - "8084:8084"
#    depends_on:
#      booking-mongodb:
#        condition: service_healthy
#    networks:
#      - shared-microservices-network
#    extra_hosts:
#      - "host.docker.internal:host-gateway"
#    healthcheck:
#      test: ["CMD-SHELL", "curl -f http://localhost:8084/actuator/health || exit 1"]
#      interval: 30s
#      timeout: 10s
#      retries: 5
#      start_period: 120s
#    restart: unless-stopped
#
#volumes:
#  # Booking Service volumes
#  booking_mongodb_data:
#    driver: local
#  booking_mongodb_config:
#    driver: local
#  booking_sonarqube_postgres_data:
#    driver: local
#  booking_sonarqube_data:
#    driver: local
#  booking_sonarqube_extensions:
#    driver: local
#  booking_sonarqube_logs:
#    driver: local
#
#networks:
#  shared-microservices-network:
#    external: true


# new version code

## Docker Compose File - Shared Microservices Network

services:
  # MongoDB Database for Booking Service
  booking-mongodb:
    image: mongo:7.0
    container_name: booking-service-mongodb
    environment:
      MONGO_INITDB_DATABASE: booking-service
    ports:
      - "27018:27017"
    volumes:
      - booking_mongodb_data:/data/db
      - booking_mongodb_config:/data/configdb
    networks:
      - shared-microservices-network
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval 'db.runCommand(\"ping\").ok' --quiet"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # SonarQube PostgreSQL for Booking Service
  booking-sonarqube-postgres:
    image: postgres:15-alpine
    container_name: booking-sonarqube-postgres
    environment:
      POSTGRES_DB: booking_sonarqube
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar123
    ports:
      - "5435:5432"
    volumes:
      - booking_sonarqube_postgres_data:/var/lib/postgresql/data
    networks:
      - shared-microservices-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sonar -d booking_sonarqube"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # SonarQube Server for Booking Service
  booking-sonarqube:
    image: sonarqube:10.7.0-community
    container_name: booking-sonarqube-server
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://booking-sonarqube-postgres:5432/booking_sonarqube
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar123
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: true
      SONAR_WEB_JAVAADDITIONALOPTS: "-Xmx512m -Xms128m"
      SONAR_CE_JAVAADDITIONALOPTS: "-Xmx512m -Xms128m"
    ports:
      - "9003:9000"
    volumes:
      - booking_sonarqube_data:/opt/sonarqube/data
      - booking_sonarqube_extensions:/opt/sonarqube/extensions
      - booking_sonarqube_logs:/opt/sonarqube/logs
    depends_on:
      booking-sonarqube-postgres:
        condition: service_healthy
    networks:
      - shared-microservices-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/api/system/status || exit 1"]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 180s
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  # Booking Service Application
  booking-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: godfrey10/booking-service:latest
    container_name: booking-service-app
    environment:
      SPRING_PROFILES_ACTIVE: docker

      # MongoDB Configuration (use service name for inter-container communication)
      SPRING_DATA_MONGODB_URI: mongodb://booking-mongodb:27017/booking-service
      SPRING_DATA_MONGODB_AUTO_INDEX_CREATION: true

      # Application Configuration
      SPRING_APPLICATION_NAME: Booking-Service
      SERVER_PORT: 8084
      SPRING_MAIN_ALLOW_BEAN_DEFINITION_OVERRIDING: true

      # Disable OAuth2 Client auto-configuration (we only need Resource Server)
      SPRING_AUTOCONFIGURE_EXCLUDE: org.springframework.boot.autoconfigure.security.oauth2.client.servlet.OAuth2ClientAutoConfiguration

      # RabbitMQ Configuration (point to existing shared-rabbitmq container)
      SPRING_RABBITMQ_HOST: shared-rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      SPRING_RABBITMQ_ENABLED: true

      # Keycloak OAuth2 Resource Server Configuration
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://localhost:8080/realms/friendly-housing
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:8080/realms/friendly-housing/protocol/openid-connect/certs

      # Keycloak OAuth2 Client Configuration (THIS IS THE KEY!)
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_ID: booking-service
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET: w17mfIu8cNiHihx8hYZEHLkEkjEA1BIf
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAK_AUTHORIZATION_GRANT_TYPE: authorization_code
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAK_SCOPE: openid,profile,email
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_ISSUER_URI: http://localhost:8080/realms/friendly-housing
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_AUTHORIZATION_URI: http://localhost:8080/realms/friendly-housing/protocol/openid-connect/auth
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_TOKEN_URI: http://keycloak:8080/realms/friendly-housing/protocol/openid-connect/token
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_USER_INFO_URI: http://keycloak:8080/realms/friendly-housing/protocol/openid-connect/userinfo
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_JWK_SET_URI: http://keycloak:8080/realms/friendly-housing/protocol/openid-connect/certs

      # Keycloak Admin Client Configuration
      KEYCLOAK_AUTH_SERVER_URL: http://keycloak:8080
      KEYCLOAK_REALM: friendly-housing
      KEYCLOAK_RESOURCE: booking-service
      KEYCLOAK_CREDENTIALS_SECRET: w17mfIu8cNiHihx8hYZEHLkEkjEA1BIf

      # Microservices URLs
      MICROSERVICES_APPOINTMENT_SERVICE_URL: http://appointment-service-app:8083
      MICROSERVICES_PROPERTY_SERVICE_URL: http://property-service-app:8082
      MICROSERVICES_USER_SERVICE_URL: http://user-service-app:8081

      # Actuator and Swagger config
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,metrics,prometheus,info
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
      MANAGEMENT_ENDPOINTS_ENABLED_BY_DEFAULT: true
      SPRINGDOC_API_DOCS_PATH: /api-docs
      SPRINGDOC_SWAGGER_UI_PATH: /swagger-ui.html
      SPRINGDOC_SWAGGER_UI_ENABLED: true

      # Logging Configuration
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_EXAMPLE_BOOKINGSERVICE: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_DATA_MONGODB: DEBUG

    ports:
      - "8084:8084"
    depends_on:
      booking-mongodb:
        condition: service_healthy
    networks:
      - shared-microservices-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8084/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

volumes:
  booking_mongodb_data:
    driver: local
  booking_mongodb_config:
    driver: local
  booking_sonarqube_postgres_data:
    driver: local
  booking_sonarqube_data:
    driver: local
  booking_sonarqube_extensions:
    driver: local
  booking_sonarqube_logs:
    driver: local

networks:
  shared-microservices-network:
    external: true
